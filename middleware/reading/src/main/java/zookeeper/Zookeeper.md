### zookeeper
首先思考一下zookeeper能够解决什么实际问题？
简单的master-slave主从结构，有三种可能失败的情况：
1. 主节点挂了: 主节点负责任务的管理，与跟踪从节点状态。主节点失效，系统无法管理任务分配任务。
2. 从节点挂了:已经分配的任务无法继续完成
3. 通信故障:主节点与从节点通信失败，从节点无法获得主节点分配的任务

主从节点：主节点master会有一个备份的master。当主节点无法工作时，需要进行故障转移，从master需要恢复到主节点崩溃时候的状态，这个状态不能从主节点获取，只能从zk获取。除了故障转移，还有当主节点因为网络或者负载原因导致超时通信时，从节点会认为主节点不可用，会接管集群，而其他的从节点可能因为网络原因无法连接到之前的master，从而连接新的master，导致集群中有2个master，从而导致状态不一致，形成2个中心，俗称“脑裂”。

#### zookeeper节点类型
1. 持久节点
2. 顺序持久节点
3. 临时节点：随着会话的关闭而自动删除，或者手动删除
4. 临时有序节点

#### zookeeper如何保证一致性
##### 设置watcher
> watcher是对节点进行监控，当发生对应的变更时，会通知客户端，每次都得单独设置监视点。下次要继续监视，得重新设置watcher。这中间可能存在一个问题，即在设置监控这段极短的时间内，有其他的更新操作没来得及通知。但是watcher在设置之前会去获取对应的数据，所以这个变更，也能通过获取数据能够接收到。 获取数据和setWatcher放在同一个请求里面，我觉得应该是一个原子操作。

##### 使用版本号
> 类似于乐观锁的概念

#### zookeeper运行模式
一. 独立模式
二. 仲裁模式：集群
> 集群模式，只有在法定个数服务器启动成功集群才能正常工作，一般法定个数超服务器半数。最好是奇数个服务器。在进行节点操作时，当达到法定个数服务器已经更新为最新状态即可返回。

问题1：为什么服务器崩溃的机器不超过法定数量，服务器就能正常工作，数据不会丢失？
> 不超过法定服务器数量，那么肯定会有机器已经是最新的数量，数据不会丢失。

问题2：客户端会不会连接到没有更新的服务器
> 这是个问题。 zookeeper的做法是对服务器按照zxid进行排序，获取最大的zxid的服务器进行连接，**服务器不会连接到本身的zxid>服务器zxid的服务器，这样就保证了数据的一致性**。

问题3：假如有abcde三台机器多次更新的时候，第一次更新，同步到abc三台机器，第二次更新同步到ade，第三次更新同步到bde，并没有一台机器是三个更新都成功的。这个会出现吗。
> 不会，在第一次更新完成后，第二次建立会话会对服务器进行排序，那肯定也是abc排在前面，选择其中一台连接，第二次同步如果到bde，第三次也一样。但还是有个问题，第二次同步到de机器的时候，因为第一次更新并没有到de，这个时候更新策略是什么样的？第一次更新会丢失吗？这个问题之后再看看

#### 会话的生命周期
未连接->连接中->连接完成->关闭
